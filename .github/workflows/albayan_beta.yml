# This workflow installs dependencies and builds Albayan using cx-Freeze on Windows

name: Albayan_beta

on:
  push:
    branches: [ "albayan_beta" ]
  pull_request:
    branches: [ "albayan_beta" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.13 (latest patch)
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Upgrade pip and install dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade cx-Freeze
        if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
        }

    - name: Build with cx-Freeze
      shell: pwsh
      run: |
        python setup.py build

    - name: Remove markdown documentation files
      shell: pwsh
      run: |
        $docPath = "albayan_build\documentation"
        if (Test-Path $docPath) {
            Remove-Item "$docPath\UserGuide.md" -ErrorAction SilentlyContinue
            Remove-Item "$docPath\WhatsNew.md" -ErrorAction SilentlyContinue
        }

    - name: Download and install latest Inno Setup
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri https://jrsoftware.org/download.php/is.exe -OutFile is.exe
        Start-Process -Wait -FilePath .\is.exe -ArgumentList '/VERYSILENT','/SUPPRESSMSGBOXES','/NORESTART','/SP'

    - name: Package with Inno Setup
      shell: pwsh
      run: |
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (!(Test-Path $isccPath)) {
            $isccPath = "C:\Program Files\Inno Setup 6\ISCC.exe"
        }
        Start-Process -Wait -FilePath $isccPath -ArgumentList "albayan.iss"

    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: albayan-beta-build
        path: albayan_build\AlbayanSetup.exe
